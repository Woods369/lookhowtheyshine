{% comment %}
This section is used in the product template to render product page with
media, content, and add-to-cart form.
{% endcomment %}

<div class="product max-w-7xl mx-auto px-4 sm:px-6 lg:px-8  mt-40">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16">
    <!-- Left Column: Product Gallery (Sticky) -->
    <div class="product-gallery lg:sticky lg:top-32 lg:h-fit">
      <div class="product-active w-full mb-4">
        {% render 'image',
        class: 'active-image w-full aspect-square object-cover transition-opacity duration-300 ease-in-out rounded-lg',
        image: product.images.first
        %}
      </div>

      <div class="product-thumbnails grid grid-cols-4 gap-4">
        {% for image in product.images %}
        <div class="thumbnail-wrapper {% if forloop.first %}selected active-thumbnail{% else %}grayscale-[0.7]{% endif %} opacity-70 hover:opacity-100 hover:grayscale-0 duration-100 ease-in-out cursor-pointer rounded-lg overflow-hidden"
          data-highres-src="{{ image | image_url: width: 1200, height: 1200, crop: 'center' }}"
          data-image-id="{{ image.id }}">
          {{ image | image_url: width: 200 | image_tag : preload: true , class: 'w-full aspect-square object-cover' }}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Column: Product Info and Form (No sticky, scrollable) -->
    <div class="product-content space-y-8">
      <!-- Product Info -->
      <div class="product-info">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ product.title }}</h1>
        <p class="js-price text-2xl font-semibold text-gray-900 mb-6">{{ product.price | money }}</p>
        <div class="prose prose-gray max-w-none">
          <p class="text-lg text-gray-600 leading-relaxed">{{ product.description }}</p>
        </div>
      </div>

      <!-- Product Form -->
      <div class="product-form">
        {% form 'product', product, class: "space-y-6" %}
          {% assign current_variant = product.selected_or_first_available_variant %}
          
          <!-- Hidden variant ID input - CRITICAL for add to cart -->
          <input type="hidden" name="id" value="{{ current_variant.id }}" class="js-variant-id">

          <div class="form-group">
            <label for="variants" class="block text-sm font-medium text-gray-700 mb-2">Variant</label>
            <div class="relative">
              <select id="variants" name="variants" class="js-variant-selector block w-full px-4 py-3 border border-gray-300 rounded-md bg-white text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none">
                {% for variant in product.variants %}
                <option value="{{ variant.id }}" {% if variant==current_variant %} selected="selected" {% endif %} data-variant-id="{{ variant.id }}" data-price="{{ variant.price }}" data-available="{{ variant.available }}">
                  {{ variant.title }} - {{ variant.price | money }}
                </option>
                {% endfor %}
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
            <input id="quantity" type="number" name="quantity" min="1" value="1"
              max="{{ current_variant.inventory_quantity }}" required
              class="block w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div class="form-group space-y-4">
            <button type="submit" class="js-add-to-cart w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-md transition-colors duration-200 {% unless current_variant.available %}bg-gray-400 cursor-not-allowed{% endunless %}" {% unless current_variant.available %}disabled{% endunless %}>
              {% if current_variant.available %}
                Add to cart
              {% else %}
                Sold out
              {% endif %}
            </button>
            {{ form | payment_button }}
          </div>
        {% endform %}
      </div>
    </div>
  </div>
</div>

{% javascript %}
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnailWrappers = document.querySelectorAll('.thumbnail-wrapper');
    const activeImage = document.querySelector('.active-image img');
    const variantSelector = document.querySelector('.js-variant-selector');
    const hiddenVariantInput = document.querySelector('.js-variant-id');
    const addToCartButton = document.querySelector('.js-add-to-cart');
    const priceElement = document.querySelector('.js-price');

    // Handle thumbnail clicks
    thumbnailWrappers.forEach(wrapper => {
      wrapper.addEventListener('click', function() {
        const highResSrc = this.dataset.highresSrc;

        // Update active image
        activeImage.src = highResSrc;
        activeImage.srcset = ''; // Clear srcset to prevent conflicts
        activeImage.alt = this.querySelector('img').alt;

        // Update active thumbnail class
        thumbnailWrappers.forEach(w => {
          w.classList.remove('active-thumbnail');
          w.classList.add('grayscale-[0.7]');
        });
        this.classList.add('active-thumbnail');
        this.classList.remove('grayscale-[0.7]');
      });
    });

    // Handle variant selection changes
    if (variantSelector && hiddenVariantInput) {
      variantSelector.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const variantId = selectedOption.dataset.variantId;
        const variantPrice = selectedOption.dataset.price;
        const isAvailable = selectedOption.dataset.available === 'true';
        
        // Update hidden input with selected variant ID
        hiddenVariantInput.value = variantId;
        
        // Update price display
        if (priceElement && variantPrice) {
          priceElement.textContent = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
          }).format(variantPrice / 100);
        }
        
        // Update add to cart button
        if (addToCartButton) {
          if (isAvailable) {
            addToCartButton.disabled = false;
            addToCartButton.textContent = 'Add to cart';
            addToCartButton.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            addToCartButton.disabled = true;
            addToCartButton.textContent = 'Sold out';
            addToCartButton.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });
    }

    // Handle add to cart form submission
    const productForm = document.querySelector('[action*="/cart/add"]');
    if (productForm) {
      productForm.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('[type="submit"]');
        if (submitButton && !submitButton.disabled) {
          submitButton.textContent = 'Adding...';
          submitButton.disabled = true;
          
          // Re-enable after 3 seconds in case of issues
          setTimeout(() => {
            submitButton.textContent = 'Add to cart';
            submitButton.disabled = false;
          }, 3000);
        }
      });
    }
  });
{% endjavascript %}

{% schema %}
  {
  "name": "t:general.product",
  "settings": [],
  "disabled_on": {
  "groups": ["header", "footer"],
  }
  }
{% endschema %}
