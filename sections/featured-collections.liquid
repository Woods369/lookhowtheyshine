{% comment %}
  This section is used in the list-collections template to render a list of
  collections with an interactive sidebar and preview area.
{% endcomment %}

{% liquid
  assign heading = "text-5xl lg:text-6xl mb-6 w-max font-black"
  assign collection_button = "collection-link w-max text-right p-2 rounded-lg lg:py-10 lg:px-20 hover:bg-gray-100 transition-all cursor-pointer border-0 hover:border-l-8"
  assign collection_button_text = "flex lg:block text-md lg:text-8xl tracking-tight font-black w-max text-right"
%}


<div class="p-6 flex flex-col lg:flex-row gap-8 lg:mx-20 relative">
  
  <!-- Halloween Blood Drop Effect -->
  {% if section.settings.enable_blood_drop %}
    {% render 'blood-drop',
      x_position: section.settings.blood_x_position,
      y_position: section.settings.blood_y_position,
      size: section.settings.blood_size,
      color: section.settings.blood_color,
      goo_particles: section.settings.goo_particles,
      speed: section.settings.animation_speed %}
  {% endif %}
  
  <!-- Collections Navigation -->
  <div class="lg:w-1/4">
    <h1 class="{{ heading }}">{{ 'collections.title' | t }}</h1>
    
    <nav class="flex flex-row gap-6 lg:gap-3 px-4 lg:flex-col overflow-x-scroll lg:overflow-hidden">
      {% if section.settings.collection_list %}
        {% for collection in section.settings.collection_list %}
          {% unless collection.products.size == 0 %}
            <button class="{{ collection_button }}" data-collection-handle="{{ collection.handle }}" data-collection-title="{{ collection.title | escape }}" data-collection-id="{{ collection.id }}" >
              <span class="{{ collection_button_text }}">{{ collection.title }}</span>
            </button>
          {% endunless %}
        {% endfor %}
      {% else  %}
        {% for collection in collections %}
          {% unless collection.products.size == 0 %}
            <button class="{{ collection_button }}" data-collection-handle="{{ collection.handle }}" data-collection-title="{{ collection.title | escape }}" data-collection-id="{{ collection.id }}" >
              <span class="{{ collection_button_text }}">{{ collection.title }}</span>
            </button>
          {% endunless %}
        {% endfor %}
      {% endif %}
    </nav>
  </div>

  <!-- Collections Preview -->
  <div class="lg:w-3/4">
    <div class="preview-default text-center py-20 h-full flex items-center">
      <div class="max-w-md mx-auto">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">Select a Collection</h2>
        <p class="text-gray-500">Click on any collection name to see products</p>
        <div class="error-message hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-sm"></div>
      </div>
    </div>

    <div class="preview-loading hidden text-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black mx-auto mb-4"></div>
      <p class="text-gray-600 text-3xl">Loading <span></span> Collection...</p>
    </div>

    <!-- Preview Content -->
    <div class="preview-content hidden">
      <div class="collection-header mb-6 flex flex-wrap justify-end items-start">
        <h2 class="collection-title hidden text-6xl h-max"></h2>
        <div class="text-right">
          <a href="#" class="group view-collection text-black transition-all duration-300 text-2xl lg:text-3xl mb-6 w-max font-thin pe-2">
            View Full Collection <span class="relative left-0 group-hover:left-2 transition-all duration-[400ms] will-change-[left]">‚Üí</span>
          </a>
        </div>
      </div>

      <!-- Products Grid (2x2) -->
      <div class="products-grid grid grid-cols-2 gap-6 mb-6">
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Featured Collections Interactive Handler
   * Manages collection selection, preview loading, and default behaviors
   * 
   * USAGE:
   * - Auto-selects default collection based on section settings
   * - Provides public API: window.selectCollection('handle')
   * - Exposes manager: window.featuredCollectionsManager
   * 
   * EXAMPLE:
   * selectCollection('halloween');  // Select by handle
   * featuredCollectionsManager.getCurrentCollection();  // Get active collection
   */

  class FeaturedCollectionsManager {
    constructor() {
      this.config = {
        defaultHandle: "{{ section.settings.default_collection.handle | default: section.settings.fallback_collection }}",
        fallbackHandle: "{{ section.settings.fallback_collection }}",
        autoSelectDelay: {{ section.settings.auto_select_delay | default: 800 }},
        loadingDelay: {{ section.settings.loading_animation_duration | default: 400 }},
        productsToShow: {{ section.settings.products_preview_count | default: 2 }},
        enableAutoSelect: {{ section.settings.enable_auto_select | default: true }}
      };
      
      this.state = {
        userHasInteracted: false,
        autoSelectionComplete: false,
        isLoading: false
      };
      
      this.elements = {
        collectionLinks: document.querySelectorAll('.collection-link'),
        previewDefault: document.querySelector('.preview-default'),
        previewLoading: document.querySelector('.preview-loading'),
        previewContent: document.querySelector('.preview-content'),
        productsGrid: document.querySelector('.products-grid'),
        viewCollectionBtn: document.querySelector('.view-collection'),
        collectionTitle: document.querySelector('.collection-title')
      };
      
      this.init();
    }
    
    init() {
      this.bindEvents();
      this.setupAutoSelection();
    }
    
    bindEvents() {
      this.elements.collectionLinks.forEach(link => {
        link.addEventListener('click', (e) => this.handleCollectionClick(e));
      });
    }
    
    setupAutoSelection() {
      if (!this.config.enableAutoSelect) return;
      
      const defaultHandle = this.config.defaultHandle || this.config.fallbackHandle;
      
      if (defaultHandle && defaultHandle !== "") {
        setTimeout(() => {
          if (!this.state.userHasInteracted && !this.state.autoSelectionComplete) {
            this.selectCollection(defaultHandle, true);
          }
        }, this.config.autoSelectDelay);
      }
    }
    
    async handleCollectionClick(event) {
      event.preventDefault();
      this.state.userHasInteracted = true;
      
      const button = event.currentTarget;
      const handle = button.dataset.collectionHandle;
      
      await this.selectCollection(handle, false);
    }
    
    async selectCollection(handle, isAutoSelect = false) {
      if (this.state.isLoading) return;
      
      const button = document.querySelector(`[data-collection-handle="${handle}"]`);
      if (!button) {
        console.warn(`Collection button not found: ${handle}`);
        return;
      }
      
      if (isAutoSelect) {
        this.animateAutoSelection(button);
        this.state.autoSelectionComplete = true;
      }
      
      this.updateActiveState(button);
      
      const title = button.dataset.collectionTitle;

      this.showLoadingState(title);
      
      try {
        await this.loadCollectionData(handle, title);
      } catch (error) {
        this.handleLoadError(error, handle);
      }
    }
    
    animateAutoSelection(button) {
      button.style.transition = "all 0.3s ease";
      button.style.transform = "scale(1.02)";
      setTimeout(() => {
        button.style.transform = "";
      }, 300);
    }
    
    updateActiveState(activeButton) {
      this.elements.collectionLinks.forEach(link => {
        link.classList.remove('border-black', 'bg-gray-100');
      });
      
      activeButton.classList.add('border-black', 'bg-gray-100');
    }
    
    showLoadingState(title) {
      this.state.isLoading = true;
    
      const loadingSpan = this.elements.previewLoading.querySelector('span');
      if (loadingSpan) loadingSpan.textContent = title;
      
      this.elements.previewDefault.classList.add('hidden');
      this.elements.previewContent.classList.add('hidden');
      this.elements.previewLoading.classList.remove('hidden');
    }
    
    async loadCollectionData(handle, title) {
      const response = await fetch(`/collections/${handle}/products.json?limit=4`);
      
      if (!response.ok) {
        throw new Error(`Failed to fetch collection: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.products || data.products.length === 0) {
        throw new Error('No products found in collection');
      }
      
      this.renderCollectionPreview(data, handle, title);
      
      setTimeout(() => {
        this.elements.previewLoading.classList.add('hidden');
        this.elements.previewContent.classList.remove('hidden');
        this.state.isLoading = false;
      }, this.config.loadingDelay);
    }
    
    renderCollectionPreview(data, handle, title) {
      this.elements.productsGrid.innerHTML = '';
      
      if (this.elements.collectionTitle) {
        this.elements.collectionTitle.textContent = title;
      }
      
      const productsToShow = data.products.slice(0, this.config.productsToShow);
      productsToShow.forEach(product => {
        const productCard = this.createProductCard(product);
        this.elements.productsGrid.appendChild(productCard);
      });
      
      if (this.elements.viewCollectionBtn) {
        this.elements.viewCollectionBtn.href = `/collections/${handle}`;
      }
    }
    
    createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card group';
      
      const imageUrl = this.getOptimizedImageUrl(product.images);
      
      card.innerHTML = `
        <a href="/products/${product.handle}" class="block relative" aria-label="View ${product.title}">
          <div class="aspect-square rounded-lg overflow-hidden mb-3">
            <img 
              src="${imageUrl}" 
              alt="${this.escapeHtml(product.title)}"
              class="w-full h-full object-cover scale-100 group-hover:scale-[1.05] transition-transform duration-700 ease-out will-change-transform"
              loading="lazy"
            />
          </div>
          <span class="text-3xl absolute bg-white opacity-0 group-hover:opacity-100 pt-5 pl-5 -bottom-6 -left-1 -right-1 group-hover:bottom-0 group-hover:text-gray-600 transition-all ease-out will-change-transform duration-[400ms]">
            ${this.escapeHtml(product.title)}
          </span>
        </a>
      `;
      
      return card;
    }
    
    getOptimizedImageUrl(images) {
      if (images && images[0] && images[0].src) {
        return images[0].src.replace(/(\.[^\.]*$)/, '_400x400$1');
      }
      return 'https://via.placeholder.com/400x400/f8f9fa/6c757d?text=No+Image';
    }
    
    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    handleLoadError(error, handle) {
      
      // Show error state
      this.elements.previewLoading.classList.add('hidden');
      this.elements.previewDefault.classList.remove('hidden');
      this.state.isLoading = false;
      
      // Optional: Show user-friendly error message
      const errorMessage = this.elements.previewDefault.querySelector('.error-message');
      if (errorMessage) {
        errorMessage.textContent = 'Unable to load collection. Please try again.';
        errorMessage.classList.remove('hidden');
      }
    }
    
    // Public API
    selectCollectionByHandle(handle) {
      return this.selectCollection(handle, false);
    }
    
    getCurrentCollection() {
      const activeButton = document.querySelector('.collection-link.border-black');
      return activeButton ? activeButton.dataset.collectionHandle : null;
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    window.featuredCollectionsManager = new FeaturedCollectionsManager();
  });
  
  window.selectCollection = function(handle) {
    if (window.featuredCollectionsManager) {
      return window.featuredCollectionsManager.selectCollectionByHandle(handle);
    }
    console.warn('Featured Collections Manager');
  };
</script>

{% schema %}
{
  "name": "Featured Collections",
  "tag": "section", 
  "class": "py-8 relative z-10 bg-white",
  "settings": [
    {
      "type": "header",
      "content": "üìö Collection Settings"
    },
    {
      "type": "collection_list",
      "id": "collection_list",
      "label": "Collections to display",
      "limit": 8,
      "info": "Choose up to 8 collections to showcase"
    },
    {
      "type": "collection",
      "id": "default_collection",
      "label": "Primary default collection",
      "info": "This collection will be automatically selected when the page loads"
    },
    {
      "type": "text",
      "id": "fallback_collection",
      "label": "Fallback collection handle",
      "default": "halloween",
      "placeholder": "halloween",
      "info": "Backup collection handle if primary default is not found (e.g., 'halloween', 'featured', 'all')"
    },
    {
      "type": "header",
      "content": "üéõÔ∏è Behavior Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_auto_select",
      "label": "Enable auto-selection",
      "default": true,
      "info": "Automatically select default collection on page load"
    },
    {
      "type": "range",
      "id": "auto_select_delay",
      "min": 200,
      "max": 2000,
      "step": 100,
      "unit": "ms",
      "label": "Auto-selection delay",
      "default": 800,
      "info": "Delay before auto-selecting default collection"
    },
    {
      "type": "range",
      "id": "products_preview_count",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Products to preview",
      "default": 2,
      "info": "Number of products to show in preview grid"
    },
    {
      "type": "range",
      "id": "loading_animation_duration",
      "min": 200,
      "max": 1000,
      "step": 50,
      "unit": "ms",
      "label": "Loading animation duration",
      "default": 400,
      "info": "Duration of loading transition animations"
    },
    {
      "type": "header",
      "content": "üéÉ Halloween Blood Drop Effects"
    },
    {
      "type": "checkbox",
      "id": "enable_blood_drop",
      "label": "Enable gooey blood drop effect",
      "default": true,
      "info": "Toggle advanced Halloween blood animation"
    },
    {
      "type": "range",
      "id": "blood_x_position",
      "min": 0,
      "max": 100, 
      "step": 5,
      "unit": "%",
      "label": "Horizontal position",
      "default": 85
    },
    {
      "type": "range",
      "id": "blood_y_position", 
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Vertical position",
      "default": 10
    },
    {
      "type": "select",
      "id": "blood_size",
      "label": "Blood drop size",
      "options": [
        {"value": "small", "label": "Small"},
        {"value": "medium", "label": "Medium"}, 
        {"value": "large", "label": "Large"}
      ],
      "default": "medium"
    },
    {
      "type": "color",
      "id": "blood_color",
      "label": "Blood drop color", 
      "default": "#D50000"
    },
    {
      "type": "range",
      "id": "goo_particles",
      "min": 20,
      "max": 120,
      "step": 10,
      "label": "Goo particles",
      "default": 80,
      "info": "Number of animated particles (affects performance)"
    },
    {
      "type": "range",
      "id": "animation_speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Animation speed",
      "default": 5,
      "info": "Duration of one animation cycle"
    }
  ],
  "presets": [{ "name": "Featured Collections" }]
}
{% endschema %}
