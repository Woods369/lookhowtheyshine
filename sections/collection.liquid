{% comment %}
  Collection Section
{% endcomment %}

{% assign is_search_page = false %}
{% assign is_collection_page = false %}
{% assign is_all_products = false %}

{% if template.name == 'search' %}
  {% assign is_search_page = true %}
{% endif %}

{% if request.page_type == 'collection' %}
  {% assign is_collection_page = true %}
{% endif %}

{% if collection.handle == 'all' %}
  {% assign is_all_products = true %}
{% endif %}

{% if is_search_page %}
  {% assign current_filters = search.filters %}
  {% assign current_sort_by = search.sort_by %}
{% else %}
  {% assign current_filters = collection.filters %}
  {% assign current_sort_by = collection.sort_by | default: collection.default_sort_by %}
{% endif %}

<div class="collection-container bg-white pt-40" data-section-id="{{ section.id }}">
  <!-- Search Bar -->
  <div class="search-bar-container bg-gray-50 border-b border-gray-200 py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <form role="search" method="get" action="{{ routes.search_url }}" class="relative">
        <input
          type="search"
          name="q"
          value="{{ search.terms | escape }}"
          placeholder="{% if is_search_page %}Search products, articles, and pages...{% elsif is_all_products %}Search all products...{% else %}Search in {{ collection.title | default: 'products' }}...{% endif %}"
          aria-label="Search products"
          class="w-full py-3 px-4 pl-12 pr-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm"
        >
        <input type="hidden" name="type" value="product">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </form>
    </div>
  </div>

  <!-- Content Area -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Mobile Filter Button -->
    {% if section.settings.enable_filtering and current_filters.size > 0 %}
      <div class="bg-white lg:hidden mb-6">
        <button type="button" id="mobile-filter-toggle"
          class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
          </svg>
          Filters & Sort
        </button>
      </div>
    {% endif %}

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 {% if section.settings.enable_filtering and current_filters.size > 0 %}lg:grid-cols-12{% endif %} gap-8">
      <!-- Sidebar Filters -->
      {% if section.settings.enable_filtering and current_filters.size > 0 %}
        <aside class="lg:col-span-4 xl:col-span-3 lg:sticky lg:top-30 bg-white z-20" id="sidebar-filters"
          style="height: fit-content;"
        >
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <form id="FacetFiltersForm" method="get"
              action="{% if is_search_page %}{{ routes.search_url }}{% else %}{{ collection.url }}{% endif %}"
              class="space-y-6"
            >
              
              <!-- Hidden inputs for search -->
              {% if is_search_page %}
                <input type="hidden" name="q" value="{{ search.terms | escape }}">
                <input type="hidden" name="type" value="product">
              {% endif %}
              
              <!-- Sort Options -->
              {% if section.settings.enable_sorting %}
                <div class="border-b border-gray-200 pb-6">
                  <div class="flex items-center justify-between cursor-pointer py-2 hover:bg-gray-50 px-2 rounded mb-4" data-collapse-toggle="sort-filter">
                    <h3 class="text-sm font-medium text-gray-900">Sort By</h3>
                    <svg class="w-4 h-4 text-gray-500 transform transition-transform duration-200 collapse-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                  <div class="collapse-content" id="sort-filter">
                    <select 
                      name="sort_by" 
                      id="sort-by" 
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                      onchange="this.form.submit()"
                    >
                      {% if is_search_page and search.sort_options %}
                        {% for option in search.sort_options %}
                          <option 
                            value="{{ option.value }}"
                            {% if option.value == current_sort_by %}selected{% endif %}
                          >
                            {{ option.name }}
                          </option>
                        {% endfor %}
                      {% elsif is_collection_page and collection.sort_options %}
                        {% for option in collection.sort_options %}
                          <option 
                            value="{{ option.value }}"
                            {% if option.value == current_sort_by %}selected{% endif %}
                          >
                            {{ option.name }}
                          </option>
                        {% endfor %}
                      {% else %}
                        <option value="manual" {% if current_sort_by == 'manual' %}selected{% endif %}>Featured</option>
                        <option value="best-selling" {% if current_sort_by == 'best-selling' %}selected{% endif %}>Best Selling</option>
                        <option value="title-ascending" {% if current_sort_by == 'title-ascending' %}selected{% endif %}>A-Z</option>
                        <option value="title-descending" {% if current_sort_by == 'title-descending' %}selected{% endif %}>Z-A</option>
                        <option value="price-ascending" {% if current_sort_by == 'price-ascending' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price-descending" {% if current_sort_by == 'price-descending' %}selected{% endif %}>Price: High to Low</option>
                        <option value="created-descending" {% if current_sort_by == 'created-descending' %}selected{% endif %}>Newest</option>
                        <option value="created-ascending" {% if current_sort_by == 'created-ascending' %}selected{% endif %}>Oldest</option>
                      {% endif %}
                    </select>
                  </div>
                </div>
              {% endif %}

              <!-- Dynamic Filters -->
              {% for filter in current_filters %}
                <div class="border-b border-gray-200 pb-6">
                  <div class="flex items-center justify-between cursor-pointer py-2 hover:bg-gray-50 px-2 rounded mb-4" data-collapse-toggle="filter-{{ forloop.index }}">
                    <h3 class="text-sm font-medium text-gray-900">{{ filter.label }}</h3>
                    <svg class="w-4 h-4 text-gray-500 transform transition-transform duration-200 collapse-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                  <div class="collapse-content hidden" id="filter-{{ forloop.index }}">
                  
                    {% case filter.type %}
                      {% when 'list' or 'boolean' %}
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                          {% for filter_value in filter.values %}
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded text-xs">
                              <input
                                type="checkbox"
                                name="{{ filter_value.param_name }}"
                                value="{{ filter_value.value }}"
                                {% if filter_value.active %}checked{% endif %}
                                class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 w-3 h-3"
                              >
                              <span class="ml-2 text-gray-700 flex-1">
                                {{ filter_value.label }}
                                <span class="text-gray-500">({{ filter_value.count }})</span>
                              </span>
                            </label>
                          {% endfor %}
                        </div>
                        
                      {% when 'price_range' %}
                        <div class="space-y-3">
                          <div>
                            <label for="filter-{{ filter.label | handle }}-min" class="block text-xs font-medium text-gray-700">Min</label>
                            <input
                              type="number"
                              id="filter-{{ filter.label | handle }}-min"
                              name="{{ filter.min_value.param_name }}"
                              value="{{ filter.min_value.value }}"
                              min="0"
                              step="0.01"
                              placeholder="{{ filter.range_min | money_without_currency | remove: ',' }}"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs"
                            >
                          </div>
                          <div>
                            <label for="filter-{{ filter.label | handle }}-max" class="block text-xs font-medium text-gray-700">Max</label>
                            <input
                              type="number"
                              id="filter-{{ filter.label | handle }}-max"
                              name="{{ filter.max_value.param_name }}"
                              value="{{ filter.max_value.value }}"
                              min="0"
                              step="0.01"
                              placeholder="{{ filter.range_max | money_without_currency | remove: ',' }}"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs"
                            >
                          </div>
                        </div>
                    {% endcase %}
                  </div>
                </div>
              {% endfor %}

              <!-- Apply Filters Button -->
              <div class="pt-2">
                <button 
                  type="submit"
                  class="w-full flex justify-center px-3 py-2 bg-blue-600 text-white rounded-md shadow-sm text-xs font-medium hover:bg-blue-700"
                >
                  Apply Filters
                </button>
              </div>

              <!-- Clear Filters -->
              {% if current_filters.size > 0 %}
                {% assign has_active_filters = false %}
                {% for filter in current_filters %}
                  {% if filter.active_values.size > 0 %}
                    {% assign has_active_filters = true %}
                  {% endif %}
                {% endfor %}
                
                {% if has_active_filters %}
                  <div class="pt-2">
                    <a 
                      href="{% if is_search_page %}{{ routes.search_url }}?q={{ search.terms | escape }}&type=product{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% else %}{{ collection.url }}{% if current_sort_by %}?sort_by={{ current_sort_by }}{% endif %}{% endif %}"
                      class="w-full flex justify-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50"
                    >
                      Clear All Filters
                    </a>
                  </div>
                {% endif %}
              {% endif %}
              
            </form>
          </div>
        </aside>
      {% endif %}

      <!-- Product Grid -->
      <main class="{% if section.settings.enable_filtering and current_filters.size > 0 %}lg:col-span-8 xl:col-span-9{% endif %}">
        
        <!-- Results Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              {% if is_search_page %}
                {% if search.terms != blank %}Search: {{ search.terms }}{% else %}Search Results{% endif %}
              {% elsif is_all_products %}
                All Products
              {% else %}
                {{ collection.title }}
              {% endif %}
            </h1>
            
            {% if is_collection_page and collection.description != blank and section.settings.show_collection_description %}
              <p class="mt-2 text-gray-600">{{ collection.description }}</p>
            {% endif %}
            
            <p class="mt-2 text-sm text-gray-500" aria-live="polite">
              {% if is_search_page %}
                {% assign results_count = search.results_count %}
              {% else %}
                {% assign results_count = collection.products_count %}
              {% endif %}
              
              {% if results_count == 0 %}
                No products found
              {% elsif results_count == 1 %}
                1 product
              {% else %}
                {{ results_count }} products
              {% endif %}
            </p>
          </div>
        </div>

        <!-- Active Filters Display -->
        {% if current_filters.size > 0 %}
          {% assign has_active_filters = false %}
          {% for filter in current_filters %}
            {% if filter.active_values.size > 0 %}
              {% assign has_active_filters = true %}
            {% endif %}
          {% endfor %}
          
          {% if has_active_filters %}
            <div class="active-filters mb-6 flex flex-wrap gap-2">
              {% for filter in current_filters %}
                {% for filter_value in filter.active_values %}
                  <a 
                    href="{{ filter_value.url_to_remove }}"
                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200"
                  >
                    {{ filter.label }}: {{ filter_value.label }}
                    <svg class="ml-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  </a>
                {% endfor %}
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}

        <!-- Product Grid -->
        {% if is_search_page %}
          {% paginate search.results by section.settings.products_per_page %}
            <div class="product-grid grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
              {% for product in search.results %}
                {% render 'product-card', product: product %}
              {% endfor %}
            </div>

            {% render 'pagination', paginate: paginate %}
          {% endpaginate %}
        {% else %}
          {% paginate collection.products by section.settings.products_per_page %}
            <div class="product-grid grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
              {% for product in collection.products %}
                {% render 'product-card', product: product %}
              {% endfor %}
            </div>

            {% render 'pagination', paginate: paginate %}
          {% endpaginate %}
        {% endif %}
        
      </main>
    </div>
  </div>
</div>

<style>
  
@media (max-width: 1023px) {
  #sidebar-filters {
    display: none; /* Hide by default on mobile */
  }
  
  #sidebar-filters.mobile-open {
    display: block !important; /* Show when open */
  }
}

  .collapse-content.hidden {
    display: none;
  }
  
  .collapsed .collapse-arrow {
    transform: rotate(-90deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Collapse functionality
    document.querySelectorAll('[data-collapse-toggle]').forEach(toggle => {
      toggle.addEventListener('click', function() {
        const targetId = this.getAttribute('data-collapse-toggle');
        const target = document.getElementById(targetId);
        const arrow = this.querySelector('.collapse-arrow');
        
        if (target.classList.contains('hidden')) {
          target.classList.remove('hidden');
          this.classList.remove('collapsed');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        } else {
          target.classList.add('hidden');
          this.classList.add('collapsed');
          if (arrow) arrow.style.transform = 'rotate(-90deg)';
        }
      });
    });

    // Initialize - Sort open by default
    const sortFilter = document.getElementById('sort-filter');
    if (sortFilter) {
      sortFilter.classList.remove('hidden');
    }

    // Mobile filter toggle
    const mobileToggle = document.getElementById('mobile-filter-toggle');
    const sidebar = document.getElementById('sidebar-filters');
    
    if (mobileToggle && sidebar) {
      mobileToggle.addEventListener('click', function() {
        sidebar.classList.toggle('mobile-open');
      });
    }
  });
</script>

{% schema %}
  {
    "name": "Collection",
    "class": "section",
    "settings": [
      {
        "type": "range",
        "id": "products_per_page",
        "min": 8,
        "max": 48,
        "step": 4,
        "default": 24,
        "label": "Products per page"
      },
      {
        "type": "checkbox",
        "id": "enable_filtering",
        "default": true,
        "label": "Enable filtering",
        "info": "Show filters for collections and search (uses native Shopify filtering)"
      },
      {
        "type": "checkbox",
        "id": "enable_sorting",
        "default": true,
        "label": "Enable sorting"
      },
      {
        "type": "checkbox",
        "id": "enable_search",
        "default": true,
        "label": "Enable search bar",
        "info": "Show search bar on collection pages"
      },
      {
        "type": "checkbox",
        "id": "show_collection_description",
        "default": true,
        "label": "Show collection description"
      }
    ]
  }
{% endschema %}