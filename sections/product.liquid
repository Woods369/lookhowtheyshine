{% comment %}
This section is used in the product template to render product page with
media, content, and add-to-cart form.
{% endcomment %}

<div class="product max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-40 bg-white">
        <div class="product-header mb-6 flex flex-wrap justify-between items-start">
        <div class="text-center relative">
          <a href="/shop" class="group view-collection text-black transition-all duration-300 text-sm md:text-2xl ps-2 block">
            <span class="left-0 group-hover:left-2 transition-all duration-[400ms] will-change-[left] rotate-180">â†’</span> Back to All Products
          </a>
        </div>
      </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16">
    <!-- Left Column: Product Gallery (Sticky) -->
    <div class="product-gallery lg:sticky lg:top-32 lg:h-fit">
      <div class="product-active w-full mb-4">
        {% render 'image',
        class: 'active-image w-full aspect-square object-cover transition-opacity duration-300 ease-in-out rounded-lg',
        image: product.images.first
        %}
      </div>

      <div class="product-thumbnails grid grid-cols-4 gap-4">
        {% for image in product.images %}
        <div class="thumbnail-wrapper {% if forloop.first %}selected active-thumbnail{% else %}grayscale-[0.7]{% endif %} opacity-70 hover:opacity-100 hover:grayscale-0 duration-100 ease-in-out cursor-pointer rounded-lg overflow-hidden"
          data-highres-src="{{ image | image_url: width: 1200, height: 1200, crop: 'center' }}"
          data-image-id="{{ image.id }}"
          data-variant="{{ image.variants.first.id }}">
          {{ image | image_url: width: 200 | image_tag : preload: true , class: 'w-full aspect-square object-cover' }}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Column: Product Info and Form (No sticky, scrollable) -->
    <div class="product-content space-y-8">
      <!-- Product Info -->
      <div class="product-info">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ product.title }}</h1>
        <p class="js-price text-2xl font-semibold text-gray-900 mb-6">{{ product.price | money }}</p>
        <div class="prose prose-gray max-w-none">
          <p class="text-lg text-gray-600 leading-relaxed">{{ product.description }}</p>
        </div>
      </div>

      <!-- Product Form -->
      <div class="product-form">
        {% form 'product', product, class: "space-y-6" %}
          {% assign current_variant = product.selected_or_first_available_variant %}
          
          <!-- Hidden variant ID input - CRITICAL for add to cart -->
          <input type="hidden" name="id" value="{{ current_variant.id }}" class="js-variant-id">


          {% unless product.variants.first.title == 'Default Title' %}
          <div class="form-group">
            {% comment %} <label for="variants" class="block text-sm font-medium text-gray-700 mb-2"></label> {% endcomment %}
            <div class="relative">
              <select id="variants" name="variants" class="js-variant-selector block w-full px-4 py-3 border border-gray-300 rounded-md bg-white text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none">
                {% for variant in product.variants %}
                  {% unless variant.title == 'Default Title' %}
                <option value="{{ variant.id }}" {% if variant==current_variant %} selected="selected" {% endif %} data-variant-id="{{ variant.id }}" data-price="{{ variant.price }}" data-available="{{ variant.available }}">
                  {{ variant.title }}
                </option>
                {% endunless %}
                {% endfor %}
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>
          </div>
          {% endunless %}

          <div class="form-group">
            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
            <input id="quantity" type="number" name="quantity" min="1" value="1"
              max="{{ current_variant.inventory_quantity }}" required
              class="block w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div class="form-group space-y-4">
            <button type="submit" class="js-add-to-cart w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-md transition-colors duration-200 {% unless current_variant.available %}bg-gray-400 cursor-not-allowed{% endunless %}" {% unless current_variant.available %}disabled{% endunless %}>
              {% if current_variant.available %}
                Add to cart
              {% else %}
                Sold out
              {% endif %}
            </button>
            {{ form | payment_button }}
          </div>
        {% endform %}
      </div>
    </div>
  </div>

<!-- Related Products from Same Collections -->
<div class="related-products mt-16">
  <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">You might also like</h2>
  
  {% assign max_products = 8 %}
  {% assign products_shown = 0 %}
  {% assign shown_product_ids = '' %}
  
  {% if products_shown < max_products %}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      {% for collection in product.collections %}
        {% for related_product in collection.products %}
          {% if related_product.available and related_product.id != product.id and products_shown < max_products %}
            {% assign product_id_string = related_product.id | append: ',' %}
            {% unless shown_product_ids contains product_id_string %}
              {% assign shown_product_ids = shown_product_ids | append: product_id_string %}
              {% assign products_shown = products_shown | plus: 1 %}
              
              <div class="group">
                <a href="{{ related_product.url }}" class="block">
                  {% if related_product.featured_image %}
                    <div class="aspect-square overflow-hidden rounded-lg bg-gray-100 mb-4">
                      <img src="{{ related_product.featured_image | image_url: width: 400, height: 400 }}" alt="{{ related_product.featured_image.alt | escape }}" width="400" height="400" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                    </div>
                  {% endif %}
                  <h3 class="text-sm font-medium text-gray-900 mb-2">{{ related_product.title }}</h3>
                  <p class="text-sm text-gray-600">{{ related_product.price | money }}</p>
                </a>
              </div>
              
            {% endunless %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
  {% endif %}
</div>


{% comment %} <section class="splide" aria-label="Splide Basic HTML Example">
  <div class="splide__track">
		<ul class="splide__list text-black">
			<li class="splide__slide text-black">Slide 01</li>
			<li class="splide__slide text-black">Slide 02</li>
			<li class="splide__slide text-black">Slide 03</li>
		</ul>
  </div>
</section> {% endcomment %}
</div>

{% javascript %}
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnailWrappers = document.querySelectorAll('.thumbnail-wrapper');
    const activeImage = document.querySelector('.active-image img');
    const variantSelector = document.querySelector('.js-variant-selector');
    const hiddenVariantInput = document.querySelector('.js-variant-id');
    const addToCartButton = document.querySelector('.js-add-to-cart');
    const priceElement = document.querySelector('.js-price');

    new Splide( '.splide' ).mount();

    // Handle thumbnail clicks
    thumbnailWrappers.forEach(wrapper => {
      wrapper.addEventListener('click', function() {
        const highResSrc = this.dataset.highresSrc;
        const thumbnailVariant = this.dataset.variant; // The variant ID from data-variant
    
        if (variantSelector && thumbnailVariant) {
          // Find the option that matches this variant
          const matchingOption = variantSelector.querySelector(`option[data-variant-id="${thumbnailVariant}"]`);
          
          if (matchingOption) {
            // Update the select value
            variantSelector.value = thumbnailVariant;
            
            // Trigger the change event to update price, availability, etc.
            const changeEvent = new Event('change', { bubbles: true });
            variantSelector.dispatchEvent(changeEvent);
          }
        }

        // Update active image
        activeImage.src = highResSrc;
        activeImage.srcset = ''; // Clear srcset to prevent conflicts
        activeImage.alt = this.querySelector('img').alt;

        // Update active thumbnail class
        thumbnailWrappers.forEach(w => {
          w.classList.remove('active-thumbnail');
          w.classList.add('grayscale-[0.7]');
        });
        this.classList.add('active-thumbnail');
        this.classList.remove('grayscale-[0.7]');
      });
    });

    // Handle variant selection changes
    if (variantSelector && hiddenVariantInput) {
      variantSelector.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const variantId = selectedOption.dataset.variantId;
        const variantPrice = selectedOption.dataset.price;
        const isAvailable = selectedOption.dataset.available === 'true';

        const targetThumbnail = document.querySelector(`[data-variant="${variantId}"]`);

            if (targetThumbnail) {
                // Remove active state from all thumbnails
                thumbnailWrappers.forEach(w => {
                    w.classList.remove('active-thumbnail');
                    w.classList.add('grayscale-[0.7]');
                });
                
                // Set new active thumbnail
                targetThumbnail.classList.add('active-thumbnail');
                targetThumbnail.classList.remove('grayscale-[0.7]');
                
                // Update the main image
                const highResSrc = targetThumbnail.dataset.highresSrc;
                activeImage.src = highResSrc;
                activeImage.alt = targetThumbnail.querySelector('img').alt;
            }


        
        // Update hidden input with selected variant ID
        hiddenVariantInput.value = variantId;
        
        // Update price display
        if (priceElement && variantPrice) {
          priceElement.textContent = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'GBP'
          }).format(variantPrice / 100);
        }
        
        // Update add to cart button
        if (addToCartButton) {
          if (isAvailable) {
            addToCartButton.disabled = false;
            addToCartButton.textContent = 'Add to cart';
            addToCartButton.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            addToCartButton.disabled = true;
            addToCartButton.textContent = 'Sold out';
            addToCartButton.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });
    }

    // Handle add to cart form submission
    const productForm = document.querySelector('[action*="/cart/add"]');
    if (productForm) {
      productForm.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('[type="submit"]');
        if (submitButton && !submitButton.disabled) {
          submitButton.textContent = 'Adding...';
          submitButton.disabled = true;
          
          // Re-enable after 3 seconds in case of issues
          setTimeout(() => {
            submitButton.textContent = 'Add to cart';
            submitButton.disabled = false;
          }, 3000);
        }
      });
    }
  });
{% endjavascript %}

{% schema %}
  {
  "name": "t:general.product",
  "settings": [],
  "disabled_on": {
  "groups": ["header", "footer"],
  }
  }
{% endschema %}
