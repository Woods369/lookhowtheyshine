<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    {% # Inlined CSS Variables %}
    {% render 'css-variables' %}

    {% # Load Tailwind CSS %}
    <script defer src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script async src="{{ 'gsap.min.js' | asset_url }}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MorphSVGPlugin.min.js"></script>
    
    {% # Social, title, etc. %}
    {% render 'meta-tags' %}
      {% if settings.favicon %}<link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">{% endif %}


    {{ content_for_header }}

    <!-- CART FORM INTERCEPTOR -->
    <script>
    document.addEventListener("submit", function(e) {
      console.log("Form submitted to:", e.target.action);
      if (e.target.action && e.target.action.includes("cart/add")) {
        console.log("INTERCEPTING CART FORM!");
        e.preventDefault();
        handleCartSubmission(e.target);
        return false;
      }
    }, true);

    async function handleCartSubmission(form) {
      const formData = new FormData(form);
      const button = form.querySelector('[type="submit"]');
      if (button) { button.textContent = "Adding..."; button.disabled = true; }
      try {
        const response = await fetch("/cart/add.json", { method: "POST", body: formData });
        if (response.ok) {
          console.log("✅ Added to cart!");
          setTimeout(() => {
            if (window.cartDrawer) { window.cartDrawer.open(); } else { alert("Item added to cart!"); }
          }, 200);
        }
      } catch (error) { console.error("❌ Error:", error); }
      finally { if (button) { button.textContent = "Add to cart"; button.disabled = false; } }
    }
    </script>

    {% comment %} <script defer src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MorphSVGPlugin.min.js"></script> {% endcomment %}
    

    {% comment %} Main JS - loads after HTML parsing but before DOMContentLoaded {% endcomment %}
    <script defer src="{{ 'main.js' | asset_url }}" type="module"></script>

    {% # Critical CSS %}
    <link rel="stylesheet" href="{{ 'critical.css' | asset_url }}">
    
    <style>
      body {
        padding-bottom: 200px;
      }

      body:has( > .main-content > header.open ) {
        max-height: 100svh;
        overflow: hidden;
      }
      
      .main-content {
        min-height: 100vh;
      }
    
    </style>
  </head>

  <body class="bg-white pb-[200px]{% if template.name == 'index' %} home {% endif %}">
    <div class="main-content z-20 relative">
      {% sections 'header-group' %}
      {{ content_for_layout }}
    </div>
    
    {% sections 'footer-group' %}
    
    {% comment %} Cart Drawer {% endcomment %}
    {% render 'cart-drawer' %}
  </body>
</html>
