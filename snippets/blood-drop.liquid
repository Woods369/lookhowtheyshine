{%- liquid
  assign x_pos = x_position | default: 85
  assign y_pos = y_position | default: 10
  assign drop_size = size | default: 'medium'
  assign drop_color = color | default: '#D50000'
  assign goo_count = goo_particles | default: 80
  assign animation_speed = speed | default: 5
  assign unique_id = x_pos | append: '-' | append: y_pos | append: '-' | append: drop_size
-%}

{%- capture size_scale -%}
  {%- case drop_size -%}
    {%- when 'small' -%}0.7
    {%- when 'medium' -%}1
    {%- when 'large' -%}1.4
  {%- endcase -%}
{%- endcapture -%}

<!-- Gooey Blood Drop Effect -->
<div class="blood-drop-container absolute" 
     style="left: {{ x_pos }}%; top: {{ y_pos }}%; transform: translate(-50%, -50%) scale({{ size_scale }}); z-index: 20;" 
     data-blood-drop-id="{{ unique_id }}">
  
  <!-- SVG Filter for Gooey Effect -->
  <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="position: absolute; width: 0; height: 0;">
    <defs>
      <filter id="fancy-goo-{{ unique_id }}">
        <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -8" result="goo" />
        <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
      </filter>
    </defs>
  </svg>
  
  <!-- Main Wrapper with Gooey Filter Applied -->
  <div class="blood-wrapper-{{ unique_id }}" 
       style="width: 130px; height: 130px; position: relative; filter: url('#fancy-goo-{{ unique_id }}'); pointer-events: none;">
    
    <!-- Blood Vessel -->
    <div class="blood-vessel-{{ unique_id }}" 
         style="width: 130px;
                height: 130px;
                border-radius: 50%;
                box-shadow: 0 0 0 4px {{ drop_color }}, 
                           inset 8px -2px {{ drop_color }}, 
                           inset 0 -63px 0 -50px {{ drop_color }}, 
                           inset 0 4px {{ drop_color }};
                overflow: hidden;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);">
      
      <!-- Main dropping blood -->
      <div class="blood-drop-{{ unique_id }}" 
           style="position: absolute;
                  width: 15px;
                  height: 15px;
                  background-color: {{ drop_color }};
                  left: 59px;
                  border-radius: 50%;
                  animation: bloodDropping-{{ unique_id }} 4s cubic-bezier(1,0,.95,-0.09) infinite;"></div>
      
      <!-- Goo particles -->
      {% for i in (1..goo_count) %}
        <div class="blood-goo-{{ unique_id }}-{{ i }}" 
             style="position: absolute;
                    width: 15px;
                    height: 15px;
                    background-color: {{ drop_color }};
                    left: 59px;
                    top: 59px;
                    border-radius: 50%;
                    transform: rotate(0deg) translateY(60px);
                    animation: bloodRotate-{{ unique_id }} {{ animation_speed }}s cubic-bezier(.27,1.22,.79,1.13) infinite;
                    animation-delay: {{ animation_speed | divided_by: goo_count | times: i | times: 1.0 }}s;"></div>
      {% endfor %}
      
      <!-- Pre drop -->
      {% comment %} <div class="hidden blood-predrop-{{ unique_id }}" 
           style="position: absolute;
                  width: 15px;
                  height: 15px;
                  background-color: {{ drop_color }};
                  left: 59px;
                  top: 59px;
                  border-radius: 50%;"></div> {% endcomment %}
        
      <!-- After drop -->
      {% comment %} <div class="hidden blood-afterdrop-{{ unique_id }}" 
           style="position: absolute;
                  width: 15px;
                  height: 15px;
                  background-color: {{ drop_color }};
                  left: 59px;
                  top: 115px;
                  border-radius: 50%;"></div> {% endcomment %}
    </div>
  </div>
</div>

<style>
  /* Keyframe Animations for {{ unique_id }} */
  @keyframes bloodDropping-{{ unique_id }} {
    from { top: 0; }
    to { top: 115px; }
  }
  
  @keyframes bloodRotate-{{ unique_id }} {
    0% {
      width: 15px; 
      height: 15px;
      transform: rotate(0deg) translateY(60px);
    }
    75% {
      width: 2px; 
      height: 2px;
      transform: rotate(135deg) translateY(60px);
    }
    100% {
      width: 15px; 
      height: 15px;
      transform: rotate(180deg) translateY(60px);
    }
  }
  
  @keyframes bloodRotateEnhanced-{{ unique_id }} {
    0% {
      width: 30px; 
      height: 30px;
      transform: rotate(0deg) translateY(60px);
    }
    75% {
      width: 2px; 
      height: 2px;
      transform: rotate(135deg) translateY(60px);
    }
    100% {
      width: 15px; 
      height: 15px;
      transform: rotate(180deg) translateY(60px);
    }
  }
  
  /* Enhanced animation for specific particles */
  .blood-goo-{{ unique_id }}-20,
  .blood-goo-{{ unique_id }}-40,
  .blood-goo-{{ unique_id }}-60 {
    animation-name: bloodRotateEnhanced-{{ unique_id }} !important;
  }
  
  /* Responsive scaling */
  @media (max-width: 768px) {
    .blood-drop-container {
      transform: translate(-50%, -50%) scale(calc({{ size_scale }} * 0.7)) !important;
    }
  }
</style>
